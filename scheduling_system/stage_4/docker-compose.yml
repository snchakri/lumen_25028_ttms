version: '3.8'

services:
  stage4:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stage4_feasibility_check
    image: lumen/stage4:latest
    
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/app
      - LOG_LEVEL=INFO
    
    volumes:
      # Mount local input_data (with files/L_raw, files/L_rel, files/L_idx) as input
      - ./input_data:/app/input_data:ro
      # Mount output directory
      - ./output_data:/app/output_data
      # Mount logs directory
      - ./logs:/app/logs
    
    working_dir: /app
    
    command: >
      python main.py
      --stage3-output /app/input_data
      --output /app/output_data
      --log-level ${LOG_LEVEL:-INFO}
      --fail-fast
      --enable-cross-layer-metrics
      --detailed-logging
    
    # Resource limits (optional - can be adjusted based on requirements)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4'
    #       memory: 8G
    #     reservations:
    #       cpus: '2'
    #       memory: 4G
    
    # Restart policy
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: Stage 4 test service
  stage4-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stage4_test
    image: lumen/stage4:latest
    
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/app
    
    volumes:
      - ./test_data:/app/test_data:ro
      - ./test_output:/app/test_output
      - ./test_logs:/app/test_logs
    
    working_dir: /app
    
    command: >
      python -m pytest tests/ -v --tb=short
    
    profiles:
      - test
    
    # Resource limits for testing
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 4G

networks:
  default:
    name: lumen_stage4_network
